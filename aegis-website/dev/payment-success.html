<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ - AEGIS</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
        <div class="payment-success-page">
            <div id="loadingState" class="payment-state">
                <div class="spinner"></div>
                <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</h2>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
            </div>
            
            <div id="successState" class="payment-state" style="display: none;">
                <div class="success-icon-large">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="40" cy="40" r="38" stroke="var(--primary)" stroke-width="4" fill="none"/>
                        <path d="M25 40 L35 50 L55 30" stroke="var(--primary)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </div>
                <h1>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                <div class="license-key-box">
                    <p class="license-label">–í–∞—à –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á:</p>
                    <div class="license-key-display">
                        <code id="licenseKey">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                        <button class="btn-copy" onclick="copyLicenseKey()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div class="license-info">
                    <p id="licenseType"></p>
                    <p class="install-hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è AEGIS</p>
                    <p class="email-hint">üìß –ö–ª—é—á —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email</p>
                </div>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            </div>
            
            <div id="errorState" class="payment-state" style="display: none;">
                <div class="error-icon-large">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="40" cy="40" r="38" stroke="var(--danger)" stroke-width="4" fill="none"/>
                        <path d="M30 30 L50 50 M50 30 L30 50" stroke="var(--danger)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2>–û—à–∏–±–∫–∞</h2>
                <p id="errorMessage">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ</p>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ hostname
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            
            // DEV –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            if (hostname.includes('devsite.aegis.builders') || hostname === 'www.devsite.aegis.builders') {
                return 'https://api-dev.aegis.builders';
            }
            
            // PROD –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            if (hostname.includes('aegis.builders') && !hostname.includes('devsite')) {
                return 'https://api.aegis.builders';
            }
            
            // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (localhost)
            return 'http://localhost:8000';
        }
        
        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Environment detected: ${window.location.hostname}`);
        console.log(`[CONFIG] API Base URL: ${API_BASE_URL}`);
        
        let checkAttempts = 0;
        const MAX_ATTEMPTS = 20; // –ú–∞–∫—Å–∏–º—É–º 20 –ø–æ–ø—ã—Ç–æ–∫ (–æ–∫–æ–ª–æ 1 –º–∏–Ω—É—Ç—ã)
        
        async function checkPayment() {
            // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º payment_id –∏–∑ sessionStorage (–æ—Ç –±—ç–∫–µ–Ω–¥–∞)
            // –ÆKassa –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –¥—Ä—É–≥–æ–π payment_id –≤ URL, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—à–∏–º
            let paymentId = sessionStorage.getItem('last_payment_id');
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –≤ sessionStorage, –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage (—Ä–µ–∑–µ—Ä–≤)
            if (!paymentId) {
                paymentId = localStorage.getItem('last_payment_id_backup');
                if (paymentId) {
                    console.log('[PAYMENT] Using payment_id from localStorage (backup from backend):', paymentId);
                }
            } else {
                console.log('[PAYMENT] ‚úÖ Using payment_id from sessionStorage (from backend):', paymentId);
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL (–ø–æ—Å–ª–µ–¥–Ω–∏–π fallback)
            if (!paymentId) {
                const urlParams = new URLSearchParams(window.location.search);
                paymentId = urlParams.get('payment_id') || urlParams.get('id');
                if (paymentId) {
                    console.warn('[PAYMENT] ‚ö†Ô∏è Using payment_id from URL (fallback - may not match backend!):', paymentId);
                    console.warn('[PAYMENT] ‚ö†Ô∏è This payment_id may not exist in database!');
                }
            }
            
            if (!paymentId) {
                console.error('[PAYMENT] Payment ID not found in sessionStorage or URL');
                showError('ID –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                return;
            }
            
            console.log('[PAYMENT] Checking payment with ID:', paymentId);
            
            checkAttempts++;
            if (checkAttempts > MAX_ATTEMPTS) {
                showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                return;
            }
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
                console.log(`[PAYMENT] Fetching status from: ${API_BASE_URL}/payments/status/${paymentId}`);
                const statusResponse = await fetch(`${API_BASE_URL}/payments/status/${paymentId}`);
                console.log(`[PAYMENT] Status response: ${statusResponse.status} ${statusResponse.statusText}`);
                
                if (!statusResponse.ok) {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 404, –ª–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
                    if (statusResponse.status === 404) {
                        const errorText = await statusResponse.text();
                        console.error(`[PAYMENT] Payment ${paymentId} not found in backend. Response:`, errorText);
                        console.error(`[PAYMENT] This payment_id was used:`, paymentId);
                        console.error(`[PAYMENT] Check if this payment_id matches the one saved in sessionStorage`);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ payment_id, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ license endpoint
                    console.log(`[PAYMENT] Trying license endpoint: ${API_BASE_URL}/payments/license/${paymentId}`);
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
                        if (licenseData.license_key) {
                            localStorage.setItem('aegis_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                        return;
                    }
                    throw new Error(`–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω (status: ${statusResponse.status}). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ payment_id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –≤–µ—Ä–Ω—É–ª –±—ç–∫–µ–Ω–¥.`);
                }
                
                const statusData = await statusResponse.json();
                console.log(`[PAYMENT] Status response data:`, statusData);
                console.log(`[PAYMENT] Payment status: ${statusData.status}`);
                
                if (statusData.status === 'succeeded') {
                    // –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –∫–ª—é—á
                    console.log(`[PAYMENT] Payment succeeded, fetching license key...`);
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    console.log(`[PAYMENT] License response status: ${licenseResponse.status} ${licenseResponse.statusText}`);
                    
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
<<<<<<< HEAD
                        console.log(`[PAYMENT] ‚úÖ License key received:`, licenseData);
=======
>>>>>>> 4264469 (WIP Wed Dec 31 12:44:59 MSK 2025)
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
                        if (licenseData.license_key) {
                            localStorage.setItem('aegis_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                    } else if (licenseResponse.status === 404) {
                        // –ï—Å–ª–∏ –∫–ª—é—á –µ—â–µ –Ω–µ –≤—ã–¥–∞–Ω, –∂–¥–µ–º (webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω)
                        const errorText = await licenseResponse.text();
                        console.warn(`[PAYMENT] ‚ö†Ô∏è License key not issued yet (404). Response:`, errorText);
                        console.log(`[PAYMENT] ‚ö†Ô∏è Waiting for webhook to process payment. Retrying in 3 seconds... (attempt ${checkAttempts}/${MAX_ATTEMPTS})`);
                        setTimeout(checkPayment, 3000);
                    } else {
                        const errorText = await licenseResponse.text();
                        console.error(`[PAYMENT] ‚ùå Failed to get license key. Status: ${licenseResponse.status}, Response:`, errorText);
                        throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á (status: ${licenseResponse.status})`);
                    }
                } else if (statusData.status === 'pending' || statusData.status === 'waiting_for_capture') {
                    // –ü–ª–∞—Ç–µ–∂ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
                    console.log(`[PAYMENT] Payment still processing (status: ${statusData.status}). Retrying in 3 seconds... (attempt ${checkAttempts}/${MAX_ATTEMPTS})`);
                    setTimeout(checkPayment, 3000);
                } else {
                    console.error(`[PAYMENT] ‚ùå Payment not completed. Status: ${statusData.status}`);
                    showError(`–ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –°—Ç–∞—Ç—É—Å: ${statusData.status}`);
                }
            } catch (error) {
                console.error('Payment check error:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
                if (checkAttempts < MAX_ATTEMPTS) {
                    setTimeout(checkPayment, 3000);
                } else {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                }
            }
        }
        
        function showSuccess(licenseKey, licenseType) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            
            document.getElementById('licenseKey').textContent = licenseKey;
            const typeText = licenseType === 'forever' 
                ? '–í–∞—à –∫–ª—é—á –¥–µ–π—Å—Ç–≤—É–µ—Ç –±–µ—Å—Å—Ä–æ—á–Ω–æ' 
                : '–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 30 –¥–Ω–µ–π';
            document.getElementById('licenseType').textContent = typeText;
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.textContent;
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', checkPayment);
    </script>
    
    <style>
        .payment-success-page {
            max-width: 600px;
            width: 100%;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .payment-state {
            padding: 20px 0;
        }
        
        .success-icon-large,
        .error-icon-large {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            width: 80px;
            height: 80px;
        }
        
        .success-icon-large svg {
            filter: drop-shadow(0 0 10px rgba(46, 79, 199, 0.5));
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        .error-icon-large svg {
            filter: drop-shadow(0 0 10px rgba(255, 92, 92, 0.5));
        }
        
        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        
        .license-key-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
        }
        
        .license-label {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .license-key-display {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .license-key-display code {
            background: var(--surface);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-weight: 600;
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }
        
        .btn-copy {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-copy:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .license-info {
            margin: 24px 0;
        }
        
        .license-info p {
            color: var(--text-muted);
            margin: 8px 0;
        }
        
        .install-hint {
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .email-hint {
            font-size: 13px;
            color: var(--primary);
            margin-top: 8px;
            font-weight: 500;
        }
        
        .action-buttons {
            margin-top: 32px;
        }
    </style>
</body>
</html>
