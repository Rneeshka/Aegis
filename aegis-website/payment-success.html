<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ - AEGIS</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
        <div class="payment-success-page">
            <div id="loadingState" class="payment-state">
                <div class="spinner"></div>
                <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</h2>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
            </div>
            
            <div id="successState" class="payment-state" style="display: none;">
                <div class="success-icon-large">‚úÖ</div>
                <h1>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                <div class="license-key-box">
                    <p class="license-label">–í–∞—à –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á:</p>
                    <div class="license-key-display">
                        <code id="licenseKey">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                        <button class="btn-copy" onclick="copyLicenseKey()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div class="license-info">
                    <p id="licenseType"></p>
                    <p class="install-hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è AEGIS</p>
                    <p class="email-hint">üìß –ö–ª—é—á —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email</p>
                </div>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            </div>
            
            <div id="errorState" class="payment-state" style="display: none;">
                <div class="error-icon-large">‚ùå</div>
                <h2>–û—à–∏–±–∫–∞</h2>
                <p id="errorMessage">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ</p>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        let checkAttempts = 0;
        const MAX_ATTEMPTS = 20; // –ú–∞–∫—Å–∏–º—É–º 20 –ø–æ–ø—ã—Ç–æ–∫ (–æ–∫–æ–ª–æ 1 –º–∏–Ω—É—Ç—ã)
        
        async function checkPayment() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å payment_id –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            let paymentId = urlParams.get('payment_id') || urlParams.get('id');
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –≤ URL, –ø—Ä–æ–≤–µ—Ä—è–µ–º sessionStorage
            if (!paymentId) {
                paymentId = sessionStorage.getItem('last_payment_id');
            }
            
            if (!paymentId) {
                showError('ID –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                return;
            }
            
            checkAttempts++;
            if (checkAttempts > MAX_ATTEMPTS) {
                showError('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                return;
            }
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
                const statusResponse = await fetch(`${API_BASE_URL}/payments/status/${paymentId}`);
                if (!statusResponse.ok) {
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ payment_id, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ license endpoint
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
                        if (licenseData.license_key) {
                            localStorage.setItem('aegis_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                        return;
                    }
                    throw new Error('–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const statusData = await statusResponse.json();
                
                if (statusData.status === 'succeeded') {
                    // –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –∫–ª—é—á
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ
                        if (licenseData.license_key) {
                            localStorage.setItem('aegis_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                    } else if (licenseResponse.status === 404) {
                        // –ï—Å–ª–∏ –∫–ª—é—á –µ—â–µ –Ω–µ –≤—ã–¥–∞–Ω, –∂–¥–µ–º (webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω)
                        setTimeout(checkPayment, 3000);
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á');
                    }
                } else if (statusData.status === 'pending' || statusData.status === 'waiting_for_capture') {
                    // –ü–ª–∞—Ç–µ–∂ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
                    setTimeout(checkPayment, 3000);
                } else {
                    showError(`–ü–ª–∞—Ç–µ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –°—Ç–∞—Ç—É—Å: ${statusData.status}`);
                }
            } catch (error) {
                console.error('Payment check error:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
                if (checkAttempts < MAX_ATTEMPTS) {
                    setTimeout(checkPayment, 3000);
                } else {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: aegisshieldos@gmail.com');
                }
            }
        }
        
        function showSuccess(licenseKey, licenseType) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            
            document.getElementById('licenseKey').textContent = licenseKey;
            const typeText = licenseType === 'forever' 
                ? '–í–∞—à –∫–ª—é—á –¥–µ–π—Å—Ç–≤—É–µ—Ç –±–µ—Å—Å—Ä–æ—á–Ω–æ' 
                : '–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 30 –¥–Ω–µ–π';
            document.getElementById('licenseType').textContent = typeText;
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.textContent;
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', checkPayment);
    </script>
    
    <style>
        .payment-success-page {
            max-width: 600px;
            width: 100%;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .payment-state {
            padding: 20px 0;
        }
        
        .success-icon-large,
        .error-icon-large {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .license-key-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
        }
        
        .license-label {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .license-key-display {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .license-key-display code {
            background: var(--surface);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-weight: 600;
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }
        
        .btn-copy {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-copy:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .license-info {
            margin: 24px 0;
        }
        
        .license-info p {
            color: var(--text-muted);
            margin: 8px 0;
        }
        
        .install-hint {
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .email-hint {
            font-size: 13px;
            color: var(--primary);
            margin-top: 8px;
            font-weight: 500;
        }
        
        .action-buttons {
            margin-top: 32px;
        }
    </style>
</body>
</html>
