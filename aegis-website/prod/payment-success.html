<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата успешна - AEGIS</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
        <div class="payment-success-page">
            <div id="loadingState" class="payment-state">
                <div class="spinner"></div>
                <h2>Проверка платежа...</h2>
                <p>Пожалуйста, подождите</p>
            </div>
            
            <div id="successState" class="payment-state" style="display: none;">
                <div class="success-icon-large">✅</div>
                <h1>Оплата успешно завершена!</h1>
                <div class="license-key-box">
                    <p class="license-label">Ваш лицензионный ключ:</p>
                    <div class="license-key-display">
                        <code id="licenseKey">Загрузка...</code>
                        <button class="btn-copy" onclick="copyLicenseKey()">Копировать</button>
                    </div>
                </div>
                <div class="license-info">
                    <p id="licenseType"></p>
                    <p class="install-hint">Используйте этот ключ для активации расширения AEGIS</p>
                </div>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">Вернуться на главную</a>
                </div>
            </div>
            
            <div id="errorState" class="payment-state" style="display: none;">
                <div class="error-icon-large">❌</div>
                <h2>Ошибка</h2>
                <p id="errorMessage">Не удалось получить информацию о платеже</p>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">Вернуться на главную</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        let checkAttempts = 0;
        const MAX_ATTEMPTS = 20; // Максимум 20 попыток (около 1 минуты)
        
        async function checkPayment() {
            // Пытаемся получить payment_id из разных источников
            const urlParams = new URLSearchParams(window.location.search);
            let paymentId = urlParams.get('payment_id') || urlParams.get('id');
            
            // Если нет в URL, проверяем sessionStorage
            if (!paymentId) {
                paymentId = sessionStorage.getItem('last_payment_id');
            }
            
            if (!paymentId) {
                showError('ID платежа не найден. Проверьте email или обратитесь в поддержку: aegisshieldos@gmail.com');
                return;
            }
            
            checkAttempts++;
            if (checkAttempts > MAX_ATTEMPTS) {
                showError('Превышено время ожидания. Пожалуйста, обратитесь в поддержку: aegisshieldos@gmail.com');
                return;
            }
            
            try {
                // Сначала проверяем статус платежа
                const statusResponse = await fetch(`${API_BASE_URL}/payments/status/${paymentId}`);
                if (!statusResponse.ok) {
                    // Если не найден по payment_id, пробуем найти через license endpoint
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        showSuccess(licenseData.license_key, licenseData.license_type);
                        return;
                    }
                    throw new Error('Платеж не найден');
                }
                
                const statusData = await statusResponse.json();
                
                if (statusData.status === 'succeeded') {
                    // Если платеж успешен, получаем ключ
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        showSuccess(licenseData.license_key, licenseData.license_type);
                    } else if (licenseResponse.status === 404) {
                        // Если ключ еще не выдан, ждем (webhook может быть еще не обработан)
                        setTimeout(checkPayment, 3000);
                    } else {
                        throw new Error('Не удалось получить ключ');
                    }
                } else if (statusData.status === 'pending' || statusData.status === 'waiting_for_capture') {
                    // Платеж еще обрабатывается
                    setTimeout(checkPayment, 3000);
                } else {
                    showError(`Платеж не завершен. Статус: ${statusData.status}`);
                }
            } catch (error) {
                console.error('Payment check error:', error);
                // Продолжаем попытки если это не критическая ошибка
                if (checkAttempts < MAX_ATTEMPTS) {
                    setTimeout(checkPayment, 3000);
                } else {
                    showError('Не удалось проверить статус платежа. Обратитесь в поддержку: aegisshieldos@gmail.com');
                }
            }
        }
        
        function showSuccess(licenseKey, licenseType) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            
            document.getElementById('licenseKey').textContent = licenseKey;
            const typeText = licenseType === 'forever' 
                ? 'Ваш ключ действует бессрочно' 
                : 'Ваша подписка активирована на 30 дней';
            document.getElementById('licenseType').textContent = typeText;
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.textContent;
                btn.textContent = 'Скопировано!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        // Запускаем проверку при загрузке страницы
        window.addEventListener('DOMContentLoaded', checkPayment);
    </script>
    
    <style>
        .payment-success-page {
            max-width: 600px;
            width: 100%;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .payment-state {
            padding: 20px 0;
        }
        
        .success-icon-large,
        .error-icon-large {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .license-key-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
        }
        
        .license-label {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .license-key-display {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .license-key-display code {
            background: var(--surface);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-weight: 600;
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }
        
        .btn-copy {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-copy:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .license-info {
            margin: 24px 0;
        }
        
        .license-info p {
            color: var(--text-muted);
            margin: 8px 0;
        }
        
        .install-hint {
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .action-buttons {
            margin-top: 32px;
        }
    </style>
</body>
</html>
