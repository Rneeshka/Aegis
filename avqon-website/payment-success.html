<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата успешна - AVQON</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
        <div class="payment-success-page">
            <div id="loadingState" class="payment-state">
                <div class="spinner"></div>
                <h2>Проверка платежа...</h2>
                <p>Пожалуйста, подождите</p>
            </div>
            
            <div id="successState" class="payment-state" style="display: none;">
                <div class="success-icon-large">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="40" cy="40" r="38" stroke="var(--primary)" stroke-width="4" fill="none"/>
                        <path d="M25 40 L35 50 L55 30" stroke="var(--primary)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                </div>
                <h1>Оплата успешно завершена!</h1>
                <div class="license-key-box">
                    <p class="license-label">Ваш лицензионный ключ:</p>
                    <div class="license-key-display">
                        <code id="licenseKey">Загрузка...</code>
                        <button class="btn-copy" onclick="copyLicenseKey()">Копировать</button>
                    </div>
                </div>
                <div class="license-info">
                    <p id="licenseType"></p>
                    <p class="install-hint">Используйте этот ключ для активации расширения AVQON</p>
                </div>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">Вернуться на главную</a>
                </div>
            </div>
            
            <div id="errorState" class="payment-state" style="display: none;">
                <div class="error-icon-large">
                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="40" cy="40" r="38" stroke="var(--danger)" stroke-width="4" fill="none"/>
                        <path d="M30 30 L50 50 M50 30 L30 50" stroke="var(--danger)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2>Ошибка</h2>
                <p id="errorMessage">Не удалось получить информацию о платеже</p>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">Вернуться на главную</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Автоматическое определение окружения по hostname
        function getApiBaseUrl() {
            const hostname = window.location.hostname.toLowerCase();
            
            // DEV окружение
            if (hostname.includes('site-dev.avqon.com') || hostname === 'www.site-dev.avqon.com') {
                return 'https://dev.avqon.com';
            }
            
            // PROD окружение (avqon.com или www.avqon.com, но не site-dev)
            if ((hostname === 'avqon.com' || hostname === 'www.avqon.com') && !hostname.includes('site-dev')) {
                return 'https://prod.avqon.com';
            }
            
            // Локальная разработка (localhost или 127.0.0.1)
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // По умолчанию используем dev порт, но можно определить по порту страницы
                const port = window.location.port;
                if (port === '8100' || port === '8101') {
                    return 'http://127.0.0.1:8100';
                }
                return 'http://127.0.0.1:8000';
            }
            
            // Fallback для других случаев - используем prod
            console.warn(`[CONFIG] Unknown hostname: ${hostname}, using PROD API`);
            return 'https://prod.avqon.com';
        }
        
        const API_BASE_URL = getApiBaseUrl();
        console.log(`[CONFIG] Environment detected: ${window.location.hostname}`);
        console.log(`[CONFIG] API Base URL: ${API_BASE_URL}`);
        
        let checkAttempts = 0;
        const MAX_ATTEMPTS = 20; // Максимум 20 попыток (около 1 минуты)
        
        async function checkPayment() {
            // КРИТИЧНО: Приоритетно используем payment_id из sessionStorage (от бэкенда)
            // ЮKassa может вернуть другой payment_id в URL, который не совпадает с нашим
            let paymentId = sessionStorage.getItem('last_payment_id');
            
            // Если нет в sessionStorage, проверяем localStorage (резерв)
            if (!paymentId) {
                paymentId = localStorage.getItem('last_payment_id_backup');
                if (paymentId) {
                    console.log('[PAYMENT] Using payment_id from localStorage (backup from backend):', paymentId);
                }
            } else {
                console.log('[PAYMENT] ✅ Using payment_id from sessionStorage (from backend):', paymentId);
            }
            
            // Если все еще нет, пытаемся получить из URL (последний fallback)
            if (!paymentId) {
                const urlParams = new URLSearchParams(window.location.search);
                paymentId = urlParams.get('payment_id') || urlParams.get('id');
                if (paymentId) {
                    console.warn('[PAYMENT] ⚠️ Using payment_id from URL (fallback - may not match backend!):', paymentId);
                    console.warn('[PAYMENT] ⚠️ This payment_id may not exist in database!');
                }
            }
            
            if (!paymentId) {
                console.error('[PAYMENT] Payment ID not found in sessionStorage or URL');
                showError('ID платежа не найден. Проверьте email или обратитесь в поддержку: support@avqon.com');
                return;
            }
            
            console.log('[PAYMENT] Checking payment with ID:', paymentId);
            
            checkAttempts++;
            if (checkAttempts > MAX_ATTEMPTS) {
                showError('Превышено время ожидания. Пожалуйста, обратитесь в поддержку: support@avqon.com');
                return;
            }
            
            try {
                // Сначала проверяем статус платежа
                console.log(`[PAYMENT] Fetching status from: ${API_BASE_URL}/payments/status/${paymentId}`);
                const statusResponse = await fetch(`${API_BASE_URL}/payments/status/${paymentId}`);
                console.log(`[PAYMENT] Status response: ${statusResponse.status} ${statusResponse.statusText}`);
                
                if (!statusResponse.ok) {
                    // Если статус 404, логируем детали
                    if (statusResponse.status === 404) {
                        const errorText = await statusResponse.text();
                        console.error(`[PAYMENT] Payment ${paymentId} not found in backend. Response:`, errorText);
                        console.error(`[PAYMENT] This payment_id was used:`, paymentId);
                        console.error(`[PAYMENT] Check if this payment_id matches the one saved in sessionStorage`);
                    }
                    
                    // Если не найден по payment_id, пробуем найти через license endpoint
                    console.log(`[PAYMENT] Trying license endpoint: ${API_BASE_URL}/payments/license/${paymentId}`);
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        // Сохраняем API ключ в localStorage для использования на сайте
                        if (licenseData.license_key) {
                            localStorage.setItem('avqon_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                        return;
                    }
                    throw new Error(`Платеж не найден (status: ${statusResponse.status}). Проверьте, что payment_id совпадает с тем, что вернул бэкенд.`);
                }
                
                const statusData = await statusResponse.json();
                console.log(`[PAYMENT] Status response data:`, statusData);
                console.log(`[PAYMENT] Payment status: ${statusData.status}`);
                
                if (statusData.status === 'succeeded') {
                    // Если платеж успешен, получаем ключ
                    console.log(`[PAYMENT] Payment succeeded, fetching license key...`);
                    const licenseResponse = await fetch(`${API_BASE_URL}/payments/license/${paymentId}`);
                    console.log(`[PAYMENT] License response status: ${licenseResponse.status} ${licenseResponse.statusText}`);
                    
                    if (licenseResponse.ok) {
                        const licenseData = await licenseResponse.json();
                        console.log(`[PAYMENT] ✅ License key received:`, licenseData);
                        // Сохраняем API ключ в localStorage для использования на сайте
                        if (licenseData.license_key) {
                            localStorage.setItem('avqon_api_key', licenseData.license_key);
                        }
                        showSuccess(licenseData.license_key, licenseData.license_type);
                    } else if (licenseResponse.status === 404) {
                        // Если ключ еще не выдан, ждем (webhook может быть еще не обработан)
                        const errorText = await licenseResponse.text();
                        console.warn(`[PAYMENT] ⚠️ License key not issued yet (404). Response:`, errorText);
                        console.log(`[PAYMENT] ⚠️ Waiting for webhook to process payment. Retrying in 3 seconds... (attempt ${checkAttempts}/${MAX_ATTEMPTS})`);
                        setTimeout(checkPayment, 3000);
                    } else {
                        const errorText = await licenseResponse.text();
                        console.error(`[PAYMENT] ❌ Failed to get license key. Status: ${licenseResponse.status}, Response:`, errorText);
                        throw new Error(`Не удалось получить ключ (status: ${licenseResponse.status})`);
                    }
                } else if (statusData.status === 'pending' || statusData.status === 'waiting_for_capture') {
                    // Платеж еще обрабатывается
                    console.log(`[PAYMENT] Payment still processing (status: ${statusData.status}). Retrying in 3 seconds... (attempt ${checkAttempts}/${MAX_ATTEMPTS})`);
                    setTimeout(checkPayment, 3000);
                } else {
                    console.error(`[PAYMENT] ❌ Payment not completed. Status: ${statusData.status}`);
                    showError(`Платеж не завершен. Статус: ${statusData.status}`);
                }
            } catch (error) {
                console.error('Payment check error:', error);
                // Продолжаем попытки если это не критическая ошибка
                if (checkAttempts < MAX_ATTEMPTS) {
                    setTimeout(checkPayment, 3000);
                } else {
                    showError('Не удалось проверить статус платежа. Обратитесь в поддержку: support@avqon.com');
                }
            }
        }
        
        function showSuccess(licenseKey, licenseType) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';
            
            document.getElementById('licenseKey').textContent = licenseKey;
            const typeText = licenseType === 'forever' 
                ? 'Ваш ключ действует бессрочно' 
                : 'Ваша подписка активирована на 30 дней';
            document.getElementById('licenseType').textContent = typeText;
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        function copyLicenseKey() {
            const key = document.getElementById('licenseKey').textContent;
            navigator.clipboard.writeText(key).then(() => {
                const btn = document.querySelector('.btn-copy');
                const originalText = btn.textContent;
                btn.textContent = 'Скопировано!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        // Запускаем проверку при загрузке страницы
        window.addEventListener('DOMContentLoaded', checkPayment);
    </script>
    
    <style>
        .payment-success-page {
            max-width: 600px;
            width: 100%;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .payment-state {
            padding: 20px 0;
        }
        
        .success-icon-large,
        .error-icon-large {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            width: 80px;
            height: 80px;
        }
        
        .success-icon-large svg {
            filter: drop-shadow(0 0 10px rgba(46, 79, 199, 0.5));
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        .error-icon-large svg {
            filter: drop-shadow(0 0 10px rgba(255, 92, 92, 0.5));
        }
        
        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        
        .license-key-box {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin: 24px 0;
        }
        
        .license-label {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .license-key-display {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .license-key-display code {
            background: var(--surface);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-weight: 600;
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }
        
        .btn-copy {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-copy:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .license-info {
            margin: 24px 0;
        }
        
        .license-info p {
            color: var(--text-muted);
            margin: 8px 0;
        }
        
        .install-hint {
            font-size: 13px;
            color: var(--text-dark);
        }
        
        .action-buttons {
            margin-top: 32px;
        }
    </style>
</body>
</html>
